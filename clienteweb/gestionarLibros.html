<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tienda de Libros</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link href="css/bootstrap-datepicker.standalone.min.css" rel="stylesheet">

</head>
<body>
    <div class="container-fluid">
        <div class="container text-center mt-5 pb-2">
            <h1 class="mt-4 mb-4 text-center">Gestionar Libros</h1>
            <div class="container mb-2 text-right">
                <div class="container mb-2 text-center">
                    <a href="index.html" class="mr-3"><i class="fas fa-home"></i> Volver al Inicio </a> |
                    <a href="gestionarAutores.html" class="ml-3"><i class="fas fa-home"></i> Gestionar Autores</a>
                </div>

            </div>
        </div>

        <div class="container">
            <div class="form-group col-md-12 text-right">
                <button id="btnNuevoLibro" class="btn btn-success" data-toggle="modal" data-target="#GuardarLibroModal">
                    <i class="fas fa-plus-square"></i> Nuevo </button>
            </div>
            <table id="tblLibros" class="table table-striped">
                <thead>
                <tr>
                    <th id="thNombre">Nombre</th>
                    <th id="thAutor">Autor</th>
                    <th id="thPrecio">Precio</th>
                    <th id="thEditorial">Editorial</th>
                    <th id="thDetalle"></th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>

    <!--
   Modal de Agregar Libro
   -->
    <div class="modal fade" id="GuardarLibroModal" tabindex="-1" role="dialog" aria-labelledby="GuardarLibroModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="GuardarLibroModalLabel">Nuevo Libro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div id="formulario" class="container border-top pt-4">
                        <div class="row">

                            <div class="form-group col-md-12">
                                <label for="txtNombreLibro">Nombre del Libro:</label>
                                <input type="text" class="form-control" id="txtNombreLibro" required>
                            </div>

                            <div class="form-group col-md-12">
                                <label for="cmbAutor">Autor:</label>
                                <select id="cmbAutor" class="form-control" required></select>
                            </div>

                            <div class='col-sm-12'>
                                <label for="txtFechaPublicacion">Fecha de Publicacion:</label>
                                <input type="text" class="form-control" id="txtFechaPublicacion" />
                            </div>

                            <div class="form-group col-md-6">
                                <label for="txtPrecio">Precio:</label>
                                <input type="text" id="txtPrecio" class="form-control" required></select>
                            </div>

                            <div class="form-group col-md-6">
                                <label for="txtPortada">Portada:</label>
                                <input type="text" class="form-control" id="txtPortada" />
                            </div>

                            <div class="form-group col-md-12">
                                <label for="txtEditorial">Editorial:</label>
                                <input type="text" class="form-control" id="txtEditorial" />
                            </div>

                            <div class="form-group col-md-12">
                                <label for="txtPrologo">Prologo:</label>
                                <textarea id="txtPrologo" class="form-control"></textarea>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="form-group col-md-12 text-right">
                        <button id="btnGuardarLibro" class="btn btn-success btn-enlinea"><i class="fas fa-save"></i> Guardar</button>
                        <button id="btnLimpiar" class="btn btn-danger btn-enlinea"><i class="fas fa-times"></i> Limpiar</button>
                        <button type="button" class="btn btn-secondary" id="btnCerrar" >Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--
    Fin Modal de Agregar Libro
    -->

    <!--
     Listado de Libros
    -->

    <div class="modal fade" id="detalleLibroModal" tabindex="-1" role="dialog" aria-labelledby="detalleLibroModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalleLibroModalLabel">Detalle del Autor</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div id="formularioMos" class="container border-top pt-4">
                        <div class="row">
                            <div class="form-group col-md-5">
                                <label for="txtMosNombreLibro">Nombre :</label>
                                <input type="text" class="form-control" id="txtMosNombreLibro" required>
                            </div>

                            <div class="form-group col-md-5">
                                <label for="txtMosAutor">Autor:</label>
                                <input type="text" class="form-control" id="txtMosAutor" required>
                            </div>

                            <div class='col-sm-5'>
                                <label for="txtMosPrecio">Precio:</label>
                                <input type="text" class="form-control" id="txtMosPrecio" />
                            </div>

                            <div class='col-sm-5'>
                                <label for="txtMosFechaPublicacion">Fecha de Publicación:</label>
                                <input type="text" class="form-control" id="txtMosFechaPublicacion" />
                            </div>

                            <div class="form-group col-md-5">
                                <label for="txtMosPortada">Portada:</label>
                                <input type="text" class="form-control" id="txtMosPortada" />
                            </div>

                            <div class="form-group col-md-5">
                                <label for="txtMosEditorial">Editorial:</label>
                                <input type="text" class="form-control" id="txtMosEditorial" />
                            </div>

                            <div class="form-group col-md-12">
                                <label for="txtMosPrologo">Prologo:</label>
                                <textarea id="txtMosPrologo" class="form-control"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!--
     Fin de Listado de Libros
    -->

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-datepicker.min.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/handlebars.min-v4.0.11.js"></script>

    <script id="template-libros" type="text/x-handlebars-template">
        {{#each libros}}
        <tr>
            <td headers="thNombre">{{this.nombre}}</td>
            <td headers="thAutor">{{this.autor.nombre}}</td>
            <td headers="thPrecio">{{this.precio}}</td>
            <td headers="thEditorial">{{this.editorial}}</td>
            <td headers="thDetalle">
                <button type="button" class="btn btn-primary" data-toggle="modal" data_id = "{{this._id}}">
                    Mostrar Detalles
                </button>
            </td>
        </tr>
        {{/each}}
    </script>

    <script>

        (function () {

            $('#btnLimpiar').on('click', limpiarFormulario);

            $('#btnCerrar').on('click', cerrarFormulario);

            $('#btnGuardarLibro').on('click', function () {
                $.ajax({
                    url:'http://localhost:5000/libros/registrar',
                    type:'POST' ,
                    data:{
                        nombre:$('#txtNombreLibro').val(),
                        autor:$('#cmbAutor').val() ,
                        precio:$('#txtPrecio').val() ,
                        fecha_publicacion:$('#txtFechaPublicacion').val() ,
                        portada:$('#txtPortada').val() ,
                        editorial:$('#txtEditorial').val() ,
                        prologo:$('#txtPrologo').val()
                    },
                    dataType:'json' ,
                    success:function (resultado) {
                        console.log(resultado);
                        limpiarFormulario() ;
                        cerrarFormulario();
                    },
                    error:function (err) {
                        console.error(err);
                    }
                });
            });

            $('#txtFechaPublicacion').datepicker();

            /* $.ajax({
                 url:'http://localhost:5000/libros/consultar',
                 type:'GET',
                 dataType:'json',
                 success:function(resultado){
                     console.log(resultado);
                 },
                 error:function (err) {
                     console.error(err);
                 }
             });*/

            $.ajax({
                url:'http://localhost:5000/autores/consultar',
                type:'GET',
                dataType:'json',
                success:function(resultado){
                    console.log(resultado);
                    //console.log(resultado.data);
                    var autores = resultado.data;
                    $('#cmbAutor').llenarCombo(autores, 'nombre', '_id');
                },
                error:function (err) {
                    console.error(err);
                }
            });

            consultarLibros() ;

        })();

        function cargarLibros(libros){

            var tblLibros = $('#tblLibros');

            var tbody = tblLibros.find('tbody');

            //Se busca el template y se obtiene el HTML como un String
            var source   = document.getElementById("template-libros").innerHTML;

            //renderFilas, es una función que reemplaza el texto en el template y retorna un string formateado
            var renderFilas = Handlebars.compile(source);

            tbody.empty();  // limpiar el contenido

            if (!Array.isArray(libros)){  //Valida que el parametro usuarios sea un arreglo
                mostrarMensajeSinDatos();
                return false;
            }
            ///Render de las filas con Handlebars
            tbody.append( renderFilas({libros:libros}) );
            tbody.find('.btn').on('click', mostrardetalle) ;
        }

        function mostrardetalle () {
            var id_libro = $(this).attr('data_id') ;
            $.ajax({
                url:'http://localhost:5000/libro/' + id_libro ,
                type:'GET',
                dataType:'json',
                success:function(resultado){
                    console.log(resultado.data);
                    mostrarDetalleLibro(resultado.data);
                },
                error:function (err) {
                    console.error(err);
                }
            });
        }

        function mostrarDetalleLibro (libro) {

            var bodyModal = $('#detalleLibroModal') ;

            bodyModal.find('#txtMosNombreLibro').val(libro.nombre);
            bodyModal.find('#txtMosAutor').val(libro.autor.nombre);
            bodyModal.find('#txtMosPrecio').val(libro.precio);
            bodyModal.find('#txtMosFechaPublicacion').val(libro.fecha_publicacion);
            bodyModal.find('#txtMosPortada').val(libro.portada);
            bodyModal.find('#txtMosEditorial').val(libro.editorial);
            bodyModal.find('#txtMosPrologo').text(libro.prologo);

            bodyModal.modal('show') ;
        }


        function consultarLibros(){

            $.ajax({
                url:'http://localhost:5000/libros/consultar',
                type:'GET',
                dataType:'json',
                success:function(resultado){
                    cargarLibros(resultado.data) ;
                    //console.error(resultado);
                },
                error:function (err) {
                    console.error(err);
                }
            });

        }

        function limpiarFormulario(){
            var formulario = $('#GuardarLibroModal');
            formulario.find('input[type="text"], textarea, input[type="email"]').val('');
            formulario.find('select').val('-1');
            formulario.find('.is-valid , .is-invalid').removeClass('is-invalid').removeClass('is-valid') ;
        }

        function cerrarFormulario(){
            var bodyModalGuardar = $('#GuardarLibroModal') ;
            bodyModalGuardar.modal('hide') ;
            consultarLibros();
        }

        function mostrarMensajeSinDatos(){
            console.log('No hay registros');
        }

    </script>


</body>
</html>